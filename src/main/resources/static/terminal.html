<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Docker Bridge Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            background-color: black;
        }
        #terminal {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<div id="terminal"></div>
<script>
    const containerId = new URLSearchParams(window.location.search).get("id");
    const socket = new WebSocket(`ws://${location.host}/ws/bridge`);
    const term = new Terminal({
        cursorBlink: true,
        fontSize: 14,
        convertEol: true,
        fontFamily: "monospace",
        theme: {
            background: "#000000",
            foreground: "#ffffff"
        }
    });

    let connected = false;
    let cmdBuffer = '';

    term.open(document.getElementById("terminal"));
    term.writeln("✅ 브릿지 터미널 연결 시도 중...");

    socket.addEventListener('open', () => {
        term.writeln("🟢 WebSocket 연결됨. 컨테이너 ID 전송 중...\n");
        socket.send(JSON.stringify({containerId}));
    });

    socket.addEventListener('message', event => {
        term.write(event.data);
        if (event.data.includes("✅ bash 세션 연결 완료")) {
            connected = true;
        }
    });

    socket.addEventListener('close', () => {
        term.write("\n❌ WebSocket 연결 종료됨.");
        connected = false;
    });

    term.onData(data => {
        if (!connected) return;
        cmdBuffer += data;
        if (data === "\r") {
            socket.send(cmdBuffer.replace("\r", ""));
            cmdBuffer = '';
        }
    });
</script>
</body>
</html>
